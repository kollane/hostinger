# ==========================================================================
# Docker Compose Init Overlay - Automatic Database Initialization
# ==========================================================================
# See fail on OVERLAY docker-compose.yml'ile
# 
# Kasutamine:
#   docker compose -f docker-compose.yml -f docker-compose.init.yml up -d
#   # VÕI
#   ../setup.sh  (valib automaatselt, kui valid option 2)
#
# Eesmärk:
#   - Lisab PostgreSQL init skriptid automaatseks skeemi loomiseks
#   - Sisaldab testimisandmeid (kasutajad, todo'd)
#   - Töötab ainult TÜHJA andmebaasiga (PostgreSQL standard)
#
# Pedagoogiline Märkus:
#   - Harjutused õpetavad KÄSITSI andmebaasi loomist (Lab 1 Harjutus 2)
#   - See fail on MUGAVUSE huvides, mitte asendus õppimisele!
#   - Soovitame esimest korda teha käsitsi, et õppida SQL'i ja docker exec'i
#
# PostgreSQL Init Skriptide Käitumine:
#   - /docker-entrypoint-initdb.d/ skriptid käitatakse AINULT kui:
#     1. Andmebaas on tühi (pole ühtegi faili volume's)
#     2. Esimesel konteiner käivitamisel
#   - Kui andmebaas juba eksisteerib → skriptid EI käivitu
#   - Kui soovid uuesti init'ida → kustuta volume ja loo uuesti
#
# Testimisandmed:
#   User Service (apps/backend-nodejs/database-setup.sql):
#     - admin@example.com (role: admin)
#     - john@example.com (role: user)
#     - jane@example.com (role: user)
#     - bob@example.com (role: user)
#
#   Todo Service (apps/backend-java-spring/database-setup.sql):
#     - 8 näidis todo'd (Eesti keeles)
#     - Erinevad prioriteedid (high, medium, low)
#     - Mõned completed, teised mitte
# ==========================================================================

version: '3.8'

services:
  # ==========================================================================
  # PostgreSQL - User Service Database
  # ==========================================================================
  # Lisab init skripti, mis loob automaatselt:
  # - user_service_db andmebaasi
  # - users tabeli
  # - indeksid
  # - 4 näidis kasutajat
  # ==========================================================================
  postgres-user:
    volumes:
      # Mount database setup SQL as init script
      # Read-only (:ro) - ei muuda originaal faili
      # /docker-entrypoint-initdb.d/ - PostgreSQL standard init kataloog
      - ../../apps/backend-nodejs/database-setup.sql:/docker-entrypoint-initdb.d/01-init.sql:ro

  # ==========================================================================
  # PostgreSQL - Todo Service Database
  # ==========================================================================
  # Lisab init skripti, mis loob automaatselt:
  # - todo_service_db andmebaasi
  # - todos tabeli
  # - indeksid ja triggerid
  # - 8 näidis todo'd
  # ==========================================================================
  postgres-todo:
    volumes:
      # Mount database setup SQL as init script
      # Read-only (:ro) - ei muuda originaal faili
      # /docker-entrypoint-initdb.d/ - PostgreSQL standard init kataloog
      - ../../apps/backend-java-spring/database-setup.sql:/docker-entrypoint-initdb.d/01-init.sql:ro

# ==========================================================================
# MÄRKUSED (NOTES)
# ==========================================================================
#
# 1. Miks Overlay Fail?
#    - Hoiab docker-compose.yml puhas (pedagoogiline versioon)
#    - Init skriptid on valikulised (opt-in, mitte default)
#    - Saab kasutada ainult kui vaja (setup.sh või käsitsi)
#
# 2. Miks Read-Only (:ro)?
#    - PostgreSQL ei muuda init skripte
#    - Vältib juhuslikke kirjutamisi volume's
#    - Best practice turva jaoks
#
# 3. Miks 01-init.sql?
#    - PostgreSQL käivitab /docker-entrypoint-initdb.d/*.sql faile
#      tähestikulises järjekorras
#    - 01- prefix tagab, et see käivitub esimesena
#    - Kui on mitu init skripti, saab järjekorda kontrollida (01-, 02-, 03-)
#
# 4. Kuidas Testimisandmeid Kasutada?
#    # Logi sisse API kaudu
#    curl -X POST http://localhost:3000/api/auth/login \
#      -H "Content-Type: application/json" \
#      -d '{"email":"john@example.com","password":"<parool-database-setup.sql'st>"}'
#
#    # Saad JWT tokeni
#    # Kasuta tokenit todo'de loomiseks/lugemiseks
#    curl http://localhost:8081/api/todos -H "Authorization: Bearer <token>"
#
# 5. Kuidas Init'ida Uuesti?
#    # Kui andmebaas juba eksisteerib ja soovid uuesti init'ida:
#    docker compose down
#    docker volume rm postgres-user-data postgres-todo-data
#    docker compose -f docker-compose.yml -f docker-compose.init.yml up -d
#
# 6. Troubleshooting:
#    # Init skriptid ei käivitu?
#    # - Kontrolli, kas volume on tühi: docker volume inspect postgres-user-data
#    # - Vaata PostgreSQL logisid: docker compose logs postgres-user
#    # - Otsing: "PostgreSQL init process complete" tähendab success
#
# ==========================================================================
