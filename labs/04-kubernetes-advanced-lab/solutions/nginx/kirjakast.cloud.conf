# ==========================================================================
# Nginx Reverse Proxy - kirjakast.cloud
# ==========================================================================
# See on reference lahendus Harjutus 01 jaoks (DNS + Nginx Reverse Proxy)
#
# Paigaldamine:
#   sudo cp kirjakast.cloud.conf /etc/nginx/sites-available/
#   sudo ln -s /etc/nginx/sites-available/kirjakast.cloud.conf /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl reload nginx
# ==========================================================================

# Defini upstream serverid (backend teenused)
upstream frontend {
    server localhost:8080;
}

upstream user-service {
    server localhost:3000;
}

upstream todo-service {
    server localhost:8081;
}

# HTTP Server Block
server {
    listen 80;
    listen [::]:80;

    server_name kirjakast.cloud www.kirjakast.cloud;

    # Logging
    access_log /var/log/nginx/kirjakast.cloud-access.log;
    error_log /var/log/nginx/kirjakast.cloud-error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ======================================================================
    # API Routes - Backend Services
    # ======================================================================

    # Todo Service API
    location /api/todos {
        proxy_pass http://todo-service;

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # User Service API - Users
    location /api/users {
        proxy_pass http://user-service;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # User Service API - Authentication
    location /api/auth {
        proxy_pass http://user-service;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ======================================================================
    # Health Check Routes
    # ======================================================================

    location /health/user {
        proxy_pass http://user-service/health;
        access_log off;
    }

    location /health/todo {
        proxy_pass http://todo-service/health;
        access_log off;
    }

    # ======================================================================
    # Frontend Routes
    # ======================================================================

    # Todo page
    location /todo {
        proxy_pass http://frontend/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Root - Frontend
    location / {
        proxy_pass http://frontend;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache static files
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://frontend;
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
}
