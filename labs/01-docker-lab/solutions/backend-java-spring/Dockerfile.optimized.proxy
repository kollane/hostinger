# ==========================================================================
# Proxy-teadlik Optimeeritud Dockerfile Todo Teenuse (Service) jaoks
# ==========================================================================
#
# See Dockerfile lahendab Docker build'ide probleeme proksi-piiratud
# corporate keskkonnas (nt. cache1.sss:3128). Kasutab ARG-p√µhist l√§henemist
# koos Gradle-spetsiifilise GRADLE_OPTS konfiguratsiooniga.
#
# KASUTUS:
# --------
#
# 1. PROXY KESKKOND (corporate v√µrk, cache1.sss):
#    docker build \
#      --build-arg HTTP_PROXY=http://cache1.sss:3128 \
#      --build-arg HTTPS_PROXY=http://cache1.sss:3128 \
#      --build-arg NO_PROXY=localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16 \
#      -f Dockerfile.optimized.proxy \
#      -t todo-service:1.0-optimized \
#      ../../../apps/backend-java-spring
#
# 2. ILMA PROXY'TA (arendaja masinas, avatud v√µrk):
#    docker build \
#      -f Dockerfile.optimized.proxy \
#      -t todo-service:1.0-optimized \
#      ../../../apps/backend-java-spring
#
# T√ÑHTIS (GRADLE PROXY):
# ----------------------
# Gradle EI kasuta HTTP_PROXY keskkonna muutujat otse!
# Gradle vajab: -Dhttp.proxyHost=cache1.sss -Dhttp.proxyPort=3128
# See Dockerfile parsib HTTP_PROXY stringi ja seadistab GRADLE_OPTS'i automaatselt.
#
# T√ÑHTIS (RUNTIME):
# -----------------
# - ARG v√§√§rtused on AINULT ehitusajal (build-time) n√§htavad
# - ENV v√§√§rtused on AINULT builder stage'is
# - Runtime konteiner EI OLE proxy's (turvalisem, portaabel)
#
# DOKUMENTATSIOON:
# ----------------
# üìñ P√µhjalik juhend: README-PROXY.md
# üìñ Gradle proxy: ../../../../resource/06A-Java-SpringBoot-NodeJS-Konteineriseerimise-Spetsiifika.md
#
# ==========================================================================

# ARG deklaratsioonid ENNE esimest FROM (globaalsed, k√µigis stage'ides)
# Vaikev√§√§rtused on t√ºhjad stringid - t√∂√∂tab ilma proksita
ARG HTTP_PROXY=""
ARG HTTPS_PROXY=""
ARG NO_PROXY=""

# ==========================================================================
# 1. ETAPP: Ehitus (Build)
# ==========================================================================
# See stage ehitab (build) JAR faili kasutades Gradle'it.
# Proksi konfiguratsioon on AINULT siin - runtime'is ei ole vaja.

FROM gradle:8.11-jdk21-alpine AS builder

# ENV ainult selles stage'is
ENV HTTP_PROXY=${HTTP_PROXY} \
    HTTPS_PROXY=${HTTPS_PROXY} \
    NO_PROXY=${NO_PROXY}

WORKDIR /app

# Kopeeri Gradle failid (s√µltuvuste (dependencies) vahem√§lu (caching) jaoks)
COPY build.gradle settings.gradle ./
COPY gradle ./gradle

# ==========================================================================
# GRADLE PROXY KONFIGURATSIOON
# ==========================================================================
# Gradle vajab spetsiifilist formaati: -Dhttp.proxyHost=HOST -Dhttp.proxyPort=PORT
# HTTP_PROXY formaat: http://cache1.sss:3128
#
# Parsinguloogika:
# 1. Eemalda "http://" prefix: cache1.sss:3128
# 2. Erista host: cache1.sss
# 3. Erista port: 3128
# 4. Seadista GRADLE_OPTS koos parsed v√§√§rtustega
#
# Kui HTTP_PROXY on t√ºhi v√µi puudub, j√§ta GRADLE_OPTS seadistamata (t√∂√∂tab ilma proksita).
# ==========================================================================

# Lae alla s√µltuvused (dependencies) (on vahem√§lus (cached), kui build.gradle ei muutu)
# Kui proxy on seadistatud, Gradle kasutab seda Maven Central'i p√∂√∂rdumiseks
RUN if [ -n "$HTTP_PROXY" ]; then \
        echo "üîß Seadistan Gradle proxy konfiguratsiooni..."; \
        # Parse proxy host (eemalda http:// ja :port)
        PROXY_HOST=$(echo "$HTTP_PROXY" | sed -e 's|http://||' -e 's|https://||' -e 's|:[0-9]*$||'); \
        # Parse proxy port (v√µta ainult numbrid l√µpust)
        PROXY_PORT=$(echo "$HTTP_PROXY" | grep -oE '[0-9]+$'); \
        echo "   Proxy host: $PROXY_HOST"; \
        echo "   Proxy port: $PROXY_PORT"; \
        # Seadista GRADLE_OPTS koos parsed v√§√§rtustega
        export GRADLE_OPTS="-Dhttp.proxyHost=$PROXY_HOST -Dhttp.proxyPort=$PROXY_PORT -Dhttps.proxyHost=$PROXY_HOST -Dhttps.proxyPort=$PROXY_PORT -Dhttp.nonProxyHosts=localhost|127.0.0.1"; \
        echo "   GRADLE_OPTS=$GRADLE_OPTS"; \
        # Lae alla s√µltuvused proksiga
        gradle dependencies --no-daemon; \
    else \
        echo "‚ÑπÔ∏è  Proxy ei ole seadistatud - laen s√µltuvused otse"; \
        # Lae alla s√µltuvused ilma proksita
        gradle dependencies --no-daemon; \
    fi

# Kopeeri l√§htekood ja ehita (build) JAR
COPY src ./src

# Ehita JAR fail (kasutab vahem√§lus cached s√µltuvusi)
# Gradle GRADLE_OPTS on endiselt aktiivne, kui seadistatud
RUN if [ -n "$HTTP_PROXY" ]; then \
        PROXY_HOST=$(echo "$HTTP_PROXY" | sed -e 's|http://||' -e 's|https://||' -e 's|:[0-9]*$||'); \
        PROXY_PORT=$(echo "$HTTP_PROXY" | grep -oE '[0-9]+$'); \
        export GRADLE_OPTS="-Dhttp.proxyHost=$PROXY_HOST -Dhttp.proxyPort=$PROXY_PORT -Dhttps.proxyHost=$PROXY_HOST -Dhttps.proxyPort=$PROXY_PORT"; \
        gradle bootJar --no-daemon; \
    else \
        gradle bootJar --no-daemon; \
    fi

# ==========================================================================
# 2. ETAPP: Runtime
# ==========================================================================
# See stage sisaldab ainult runtime'i vajalikku koodi (JRE + JAR).
# ‚ö†Ô∏è T√ÑHTIS: ENV muutujad EI OLE siin - runtime konteiner on "clean"!

FROM eclipse-temurin:21-jre-alpine

# ‚ö†Ô∏è PROXY ENV MUUTUJAD EI OLE SIIN!
# Iga FROM k√§sk nullib ENV muutujad - runtime on proksi-vaba.
# See on √ïIGE k√§itumine:
# - Runtime'is ei ole vaja proksi (konteinerid suhtlevad LXD sisev√µrgus)
# - Turvalisem (proxy info ei leki runtime konteineri)
# - Portaabel (sama image t√∂√∂tab m√µlemas keskkonnas)

WORKDIR /app

# Loo mitte-juurkasutaja (non-root user)
# Turvalisuse best practice: √§ra k√§ivita rakendust root'ina
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001 -G spring

# Kopeeri ainult JAR fail ehitaja (builder) etapist
# --from=builder v√µtab JAR faili eelmisest stage'ist
# --chown=spring:spring m√§√§rab faili omanikuks spring kasutaja
COPY --from=builder --chown=spring:spring /app/build/libs/todo-service.jar app.jar

# Kasuta mitte-juurkasutajat (non-root user)
USER spring:spring

EXPOSE 8081

# Seisukorra kontroll (health check) (kontrollib iga 30s, ajal√µpp 3s, alguse ooteaeg 40s)
# Docker kasutab seda, et kontrollida konteineri tervist
# Pikk start-period (40s) sest Spring Boot k√§ivitus v√µtab aega
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8081/health || exit 1

# K√§ivita rakendus (application) JVM m√§lu h√§√§lestamisega (konteineriteadlik)
# -XX:InitialRAMPercentage=80: Algne heap size 80% konteiner RAM'ist
# -XX:MaxRAMPercentage=80: Maksimaalne heap size 80% konteiner RAM'ist
CMD ["java", \
    "-XX:InitialRAMPercentage=80", \
    "-XX:MaxRAMPercentage=80", \
    "-jar", \
    "app.jar"]

# ==========================================================================
# M√ÑRKUSED:
# ==========================================================================
#
# M√ÑRKUS 1: Gradle vs. npm Proxy Konfiguratsioon
# -----------------------------------------------
# npm:     Kasutab HTTP_PROXY keskkonna muutujat otse ‚úÖ
# Gradle:  EI kasuta HTTP_PROXY otse ‚ùå
#          Vajab: -Dhttp.proxyHost=HOST -Dhttp.proxyPort=PORT
#
# Sellep√§rast on Gradle konfiguratsioon keerulisem (vajab parsing'ut).
#
# M√ÑRKUS 2: Gradle Proxy Alternatiivid
# -------------------------------------
# Meetod 1 (see Dockerfile): GRADLE_OPTS koos parsing'uga ‚úÖ PARIM
# Meetod 2: ~/.gradle/gradle.properties fail (vajab koopia Dockerfile'i)
# Meetod 3: Hardcoded GRADLE_OPTS (ei ole portaabel) ‚ùå
#
# M√ÑRKUS 3: Proxy vs. Firewall
# -----------------------------
# Corporate keskkonnas:
# - Otse√ºhendus internetti on blokeeritud (firewall)
# - K√µik HTTP/HTTPS liiklus peab minema l√§bi proksi (cache1.sss:3128)
# - gradle dependencies eba√µnnestub ilma proksi konfiguratsioonita
#
# M√ÑRKUS 4: Miks ARG, mitte hardcoded ENV?
# -----------------------------------------
# ‚úÖ ARG-p√µhine (see Dockerfile):
#    - Portaabel (t√∂√∂tab proksi ja ilma)
#    - Turvaline (ei leki runtime'i)
#    - Production-ready
#
# ‚ùå Hardcoded ENV (vt. Dockerfile.proxy-hardcoded):
#    - T√∂√∂tab ainult cache1.sss v√µrgus
#    - Proxy leak'ib runtime'i (turvaviga)
#    - Tekitab technical debt
#
# M√ÑRKUS 5: Testimine
# -------------------
# Veendu, et proxy ei leki runtime'i:
#
#   docker run --rm todo-service:1.0-optimized env | grep -i proxy
#
# Tulemus peaks olema T√úHI (ei leia midagi). Kui n√§ed HTTP_PROXY=... v√µi
# GRADLE_OPTS=..., siis on proxy leakinud runtime'i - see on VIGA! ‚ö†Ô∏è
#
# M√ÑRKUS 6: Pildi (Image) Suurus
# -------------------------------
# Multi-stage build v√§hendab image suurust:
# - Builder stage: ~600MB (JDK + Gradle + s√µltuvused)
# - Runtime stage: ~250MB (ainult JRE + JAR)
# - Proxy konfiguratsioon ei suurenda image suurust!
#
# ==========================================================================
