# ==========================================================================
# ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ANTI-PATTERN DEMONSTRATION (GRADLE VARIANT) ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
# ==========================================================================
#
# See Dockerfile demonstreerib, mida MITTE TEHA Gradle projektides!
#
# PROBLEEMID:
# -----------
# ‚ùå EI OLE porteeritav (t√∂√∂tab ainult cache1.sss v√µrgus)
# ‚ùå Proxy LEAK'ib runtime konteineri (turvaviga)
# ‚ùå GRADLE_OPTS on runtime'is (ei ole vaja, confusion)
# ‚ùå Tekitab technical debt (tuleb refaktorida)
# ‚ùå Arendaja masinas ei t√∂√∂ta (ei saa testida)
# ‚ùå CI/CD pipeline'is eba√µnnestub (kui ei ole cache1.sss)
# ‚ùå Image ei ole taaskasutatav teistes keskkondades
#
# MIKS selline kood eksisteerib corporate keskkonnas?
# ----------------------------------------------------
# - Quick fix surve all (deadline'id)
# - Arendaja ei tea Gradle proxy konfiguratsiooni (complex)
# - Copy-paste StackOverflow'st (ilma m√µistmata)
# - "It works, don't touch it" kultuur
# - Legacy code, mida keegi ei julge puutuda
# - Gradle dokumentatsioon ei ole selge (systemProp vs GRADLE_OPTS)
#
# √ïIGE LAHENDUS:
# --------------
# ‚úÖ Kasuta Dockerfile.optimized.proxy (ARG-p√µhine + parsing)
# ‚úÖ Proxy seadistamine build arg'idega
# ‚úÖ Runtime konteiner clean (ei leki proksi)
# ‚úÖ Portaabel (t√∂√∂tab proksi ja ilma)
#
# KASUTUS (AINULT DEMONSTRATSIOONIKS):
# -------------------------------------
# docker build \
#   -f Dockerfile.proxy-hardcoded \
#   -t todo-service:1.0-hardcoded \
#   ../../../apps/backend-java-spring
#
# ‚ö†Ô∏è See t√∂√∂tab AINULT cache1.sss v√µrgus!
# ‚ö†Ô∏è Arendaja masinas eba√µnnestub!
#
# ==========================================================================

FROM gradle:8.11-jdk21-alpine

# ‚ö†Ô∏è HARDCODED GRADLE PROXY - EI T√ñ√ñTA arendaja masinas!
# Gradle vajab spetsiifilist formaati (mitte HTTP_PROXY)
ENV GRADLE_OPTS="-Dhttp.proxyHost=cache1.sss -Dhttp.proxyPort=3128 -Dhttps.proxyHost=cache1.sss -Dhttps.proxyPort=3128 -Dhttp.nonProxyHosts=localhost|127.0.0.1"

# ‚ö†Ô∏è Lisaks ka HTTP_PROXY (m√µned tool'id kasutavad seda)
ENV HTTP_PROXY=http://cache1.sss:3128 \
    HTTPS_PROXY=http://cache1.sss:3128 \
    NO_PROXY=localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16

# ‚ö†Ô∏è Probleem: Proxy info on n√º√ºd KOGU image'is!
# See on p√µhjus #1, miks see on halb:
# - Kui kolleeg kloonib repo ja ehitab: ‚ùå Timeout (ei ole cache1.sss v√µrgus)
# - Kui deploy'id AWS'i: ‚ùå Runtime proovib kasutada cache1.sss:3128
# - Kui testi lokaalselt: ‚ùå Connection refused

WORKDIR /app

# Kopeeri Gradle failid
COPY build.gradle settings.gradle ./
COPY gradle ./gradle

# gradle dependencies kasutab hardcoded GRADLE_OPTS
RUN gradle dependencies --no-daemon

# Kopeeri l√§htekood ja ehita
COPY src ./src
RUN gradle bootJar --no-daemon

# Kopeeri JAR
RUN cp /app/build/libs/todo-service.jar /app/app.jar

EXPOSE 8081

# ‚ö†Ô∏è GRADLE_OPTS on runtime'is ALLES (leak!)
# Testi: docker run --rm todo-service:1.0-hardcoded env | grep GRADLE
# N√§ed: GRADLE_OPTS=-Dhttp.proxyHost=cache1.sss ...
# See EI PEAKS olema runtime'is - Java rakendus ei vaja Gradle'i!

CMD ["java", \
    "-XX:InitialRAMPercentage=80", \
    "-XX:MaxRAMPercentage=80", \
    "-jar", \
    "app.jar"]

# ==========================================================================
# GRADLE PROXY CONFUSION:
# ==========================================================================
#
# Gradle proxy konfiguratsiooni on KOLM meetodit, mis tekitab segadust:
#
# MEETOD 1: GRADLE_OPTS (see fail)
# --------------------------------
# ENV GRADLE_OPTS="-Dhttp.proxyHost=cache1.sss -Dhttp.proxyPort=3128"
#
# Probleemid:
# - ‚ùå Hardcoded (ei ole portaabel)
# - ‚ùå Leak'ib runtime'i (ei ole vaja)
# - ‚ùå Verbose (pikk string)
#
# MEETOD 2: gradle.properties fail
# ---------------------------------
# COPY gradle.properties $GRADLE_USER_HOME/gradle.properties
#
# gradle.properties:
#   systemProp.http.proxyHost=cache1.sss
#   systemProp.http.proxyPort=3128
#
# Probleemid:
# - ‚ùå Hardcoded fail (ei ole portaabel)
# - ‚ùå Lisafail (maintenance overhead)
# - ‚ùå V√µib leakida repo'sse (.gitignore?)
#
# MEETOD 3: ARG + parsing (√ïIGE, vt. Dockerfile.optimized.proxy)
# ----------------------------------------------------------------
# ARG HTTP_PROXY=""
# RUN if [ -n "$HTTP_PROXY" ]; then
#       PROXY_HOST=$(echo $HTTP_PROXY | sed ...);
#       PROXY_PORT=$(echo $HTTP_PROXY | grep -oE ...);
#       export GRADLE_OPTS="...";
#     fi
#
# Eelised:
# - ‚úÖ Portaabel (t√∂√∂tab proksi ja ilma)
# - ‚úÖ Ei leki runtime'i (ainult builder stage'is)
# - ‚úÖ Standard HTTP_PROXY formaat (nagu npm)
#
# ==========================================================================
#
# REFAKTORIMISE JUHEND:
# ==========================================================================
#
# Kui sa leiad corporate codebase'ist sellise Dockerfile'i:
#
# SAMM 1: Liigu multi-stage build'ile
# ------------------------------------
# - Builder stage: Gradle + JDK (proxy siin)
# - Runtime stage: JRE ainult (proxy EI OLE)
#
# SAMM 2: Asenda hardcoded GRADLE_OPTS ARG'idega
# -----------------------------------------------
# Eemalda:  ENV GRADLE_OPTS="-Dhttp.proxyHost=..."
# Lisa:     ARG HTTP_PROXY=""
#           RUN if [ -n "$HTTP_PROXY" ]; then ... fi
#
# SAMM 3: Uuenda build k√§sud
# ---------------------------
# Build proksiga:
#   docker build --build-arg HTTP_PROXY=http://cache1.sss:3128 ...
#
# Build ilma:
#   docker build ...
#
# SAMM 4: Verifitseeri runtime
# -----------------------------
# docker run --rm todo-service:1.0 env | grep -i proxy
# Tulemus peaks olema T√úHI ‚úÖ
#
# ==========================================================================
#
# CORPORATE SURVIVAL TIP (GRADLE VARIANT):
# -----------------------------------------
# Gradle proxy on keeruline - kolleegid v√µivad karta refaktoorida.
#
# Strateegia:
# 1. Loo working prototype: Dockerfile.optimized.proxy
# 2. N√§ita diff'i: du -sh <images> (600MB ‚Üí 250MB)
# 3. Demonstreeri portability: ehita m√µlemas keskkonnas
# 4. Paku migreerimisplaani: deprecated vana ‚Üí uus
# 5. Paku abi: "Ma testi sinu branch'i koos"
# 6. Dokumenteeri: README-PROXY.md
#
# Gradle proxy'ga on palju technical debt'i - ole kannatlik! üí™
#
# ==========================================================================
#
# LINGID:
# -------
# üìñ √ïige lahendus: Dockerfile.optimized.proxy
# üìñ Dokumentatsioon: README-PROXY.md
# üìñ Gradle spetsiifika: ../../../../resource/06A-Java-SpringBoot-NodeJS-Konteineriseerimise-Spetsiifika.md
#
# ==========================================================================
