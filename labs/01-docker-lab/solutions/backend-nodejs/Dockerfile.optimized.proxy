# syntax=docker/dockerfile:1.4
# ‚òùÔ∏è BuildKit syntax versiooni m√§√§rang - v√§hendab UndefinedVar hoiatusi
#
# ==========================================================================
# Proxy-teadlik Optimeeritud Dockerfile User Teenuse (Service) jaoks
# ==========================================================================
#
# See Dockerfile lahendab Docker build'ide probleeme proksi-piiratud
# corporate keskkonnas (nt. cache1.sss:3128). Kasutab ARG-p√µhist l√§henemist,
# mis t√∂√∂tab M√ïLEMAS keskkonnas - nii proksi kui ilma.
#
# KASUTUS:
# --------
#
# 1. PROXY KESKKOND (corporate v√µrk, cache1.sss):
#    docker build \
#      --build-arg HTTP_PROXY=http://cache1.sss:3128 \
#      --build-arg HTTPS_PROXY=http://cache1.sss:3128 \
#      --build-arg NO_PROXY=localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16 \
#      -f Dockerfile.optimized.proxy \
#      -t user-service:1.0-optimized \
#      ../../../apps/backend-nodejs
#
# 2. ILMA PROXY'TA (arendaja masinas, avatud v√µrk):
#    docker build \
#      -f Dockerfile.optimized.proxy \
#      -t user-service:1.0-optimized \
#      ../../../apps/backend-nodejs
#
# T√ÑHTIS:
# -------
# - ARG v√§√§rtused on AINULT ehitusajal (build-time) n√§htavad
# - ENV v√§√§rtused on AINULT builder stage'is (dependencies)
# - Runtime konteiner EI OLE proxy's (turvalisem, portaabel)
# - npm ci respekteerib HTTP_PROXY/HTTPS_PROXY keskkonna muutujaid automaatselt
#
# DOKUMENTATSIOON:
# ----------------
# üìñ P√µhjalik juhend: README-PROXY.md
# üìñ Teooria: ../../../../resource/06-Dockerfile-Rakenduste-Konteineriseerimise-Detailid.md
#
# ==========================================================================

# ARG deklaratsioonid ENNE esimest FROM (globaalsed, k√µigis stage'ides)
# Vaikev√§√§rtused on t√ºhjad stringid - t√∂√∂tab ilma proksita
ARG HTTP_PROXY=""
ARG HTTPS_PROXY=""
ARG NO_PROXY=""

# ==========================================================================
# 1. ETAPP: S√µltuvused (Dependencies)
# ==========================================================================
# See stage laeb alla ja installib npm paketid.
# Proksi konfiguratsioon on AINULT siin - runtime'is ei ole vaja.

FROM node:22-slim AS dependencies

# ENV ainult selles stage'is - npm ci kasutab neid
# M√§rkus: ${ARG} s√ºntaks v√µtab ARG v√§√§rtused, kui need on antud
ENV HTTP_PROXY=${HTTP_PROXY} \
    HTTPS_PROXY=${HTTPS_PROXY} \
    NO_PROXY=${NO_PROXY}

WORKDIR /app

# Kopeeri s√µltuvuste (dependency) failid (vahem√§lu (caching) jaoks)
# Muutes ainult package*.json'i, triggerdab see npm install'i uuesti
COPY package*.json ./

# Installi AINULT tootmise s√µltuvused (production dependencies)
# npm ci respekteerib HTTP_PROXY/HTTPS_PROXY keskkonna muutujaid automaatselt
# Kui proxy on seadistatud, npm kasutab seda registry.npmjs.org'i p√∂√∂rdumiseks
RUN npm ci --only=production

# ==========================================================================
# 2. ETAPP: Runtime
# ==========================================================================
# See stage sisaldab ainult runtime'i vajalikku koodi ja s√µltuvusi.
# ‚ö†Ô∏è T√ÑHTIS: ENV muutujad EI OLE siin - runtime konteiner on "clean"!

FROM node:22-slim

# ‚ö†Ô∏è PROXY ENV MUUTUJAD EI OLE SIIN!
# Iga FROM k√§sk nullib ENV muutujad - runtime on proksi-vaba.
# See on √ïIGE k√§itumine:
# - Runtime'is ei ole vaja proksi (konteinerid suhtlevad LXD sisev√µrgus)
# - Turvalisem (proxy info ei leki runtime konteineri)
# - Portaabel (sama image t√∂√∂tab m√µlemas keskkonnas)

WORKDIR /app

# Loo mitte-juurkasutaja (non-root user)
# Turvalisuse best practice: √§ra k√§ivita rakendust root'ina
RUN groupadd -g 1001 nodejs && \
    useradd -r -u 1001 -g nodejs nodejs

# Kopeeri s√µltuvused (dependencies) ehitaja (builder) etapist
# --from=dependencies v√µtab node_modules eelmisest stage'ist
# --chown=nodejs:nodejs m√§√§rab failide omanikuks nodejs kasutaja
COPY --from=dependencies --chown=nodejs:nodejs /app/node_modules ./node_modules

# Kopeeri rakenduse (application) kood
COPY --chown=nodejs:nodejs . .

# Kasuta mitte-juurkasutajat (non-root user)
USER nodejs:nodejs

EXPOSE 3000

# Seisukorra kontroll (Health check)
# Docker kasutab seda, et kontrollida konteineri tervist
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s \
  CMD node healthcheck.js || exit 1

CMD ["node", "server.js"]

# ==========================================================================
# M√ÑRKUSED:
# ==========================================================================
#
# M√ÑRKUS 1: Miks node:22-slim (mitte Alpine)?
# --------------------------------------------
# - bcrypt natiivmoodulid ei t√∂√∂ta korrektselt Alpine'is
# - Kompromiss: Pildi (image) suurus ~305MB (vs ~200MB Alpine)
# - Aga bcrypt t√∂√∂tab stabiilselt ilma lisat√∂√∂riistadeta
#
# M√ÑRKUS 2: Proxy vs. Firewall
# -----------------------------
# Corporate keskkonnas:
# - Otse√ºhendus internetti on blokeeritud (firewall)
# - K√µik HTTP/HTTPS liiklus peab minema l√§bi proksi (cache1.sss:3128)
# - npm install eba√µnnestub ilma proksi konfiguratsioonita
#
# M√ÑRKUS 3: Miks ARG, mitte hardcoded ENV?
# -----------------------------------------
# ‚úÖ ARG-p√µhine (see Dockerfile):
#    - Portaabel (t√∂√∂tab proksi ja ilma)
#    - Turvaline (ei leki runtime'i)
#    - Production-ready
#
# ‚ùå Hardcoded ENV (vt. Dockerfile.proxy-hardcoded):
#    - T√∂√∂tab ainult cache1.sss v√µrgus
#    - Proxy leak'ib runtime'i (turvaviga)
#    - Tekitab technical debt
#
# M√ÑRKUS 4: Testimine
# -------------------
# Veendu, et proxy ei leki runtime'i:
#
#   docker run --rm user-service:1.0-optimized env | grep -i proxy
#
# Tulemus peaks olema T√úHI (ei leia midagi). Kui n√§ed HTTP_PROXY=...,
# siis on proxy leakinud runtime'i - see on VIGA! ‚ö†Ô∏è
#
# ==========================================================================
