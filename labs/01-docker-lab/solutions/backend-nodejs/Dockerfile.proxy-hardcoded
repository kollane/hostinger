# ==========================================================================
# ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ANTI-PATTERN DEMONSTRATION ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
# ==========================================================================
#
# See Dockerfile demonstreerib, mida MITTE TEHA!
#
# PROBLEEMID:
# -----------
# ‚ùå EI OLE porteeritav (t√∂√∂tab ainult cache1.sss v√µrgus)
# ‚ùå Proxy LEAK'ib runtime konteineri (turvaviga)
# ‚ùå Tekitab technical debt (tuleb refaktorida)
# ‚ùå Arendaja masinas ei t√∂√∂ta (ei saa testida)
# ‚ùå CI/CD pipeline'is eba√µnnestub (kui ei ole cache1.sss)
# ‚ùå Image ei ole taaskasutatav teistes keskkondades
#
# MIKS selline kood eksisteerib corporate keskkonnas?
# ----------------------------------------------------
# - Quick fix surve all (deadline'id)
# - Arendaja ei tea paremat meetodit (√µppimisv√µimaluse puudumine)
# - "It works, don't touch it" kultuur (kardatakse refaktorida)
# - Copy-paste StackOverflow'st (ilma m√µistmata)
# - Legacy code, mida keegi ei julge puutuda
#
# √ïIGE LAHENDUS:
# --------------
# ‚úÖ Kasuta Dockerfile.optimized.proxy (ARG-p√µhine)
# ‚úÖ Proxy seadistamine build arg'idega
# ‚úÖ Runtime konteiner clean (ei leki proksi)
# ‚úÖ Portaabel (t√∂√∂tab proksi ja ilma)
#
# KASUTUS (AINULT DEMONSTRATSIOONIKS):
# -------------------------------------
# docker build \
#   -f Dockerfile.proxy-hardcoded \
#   -t user-service:1.0-hardcoded \
#   ../../../apps/backend-nodejs
#
# ‚ö†Ô∏è See t√∂√∂tab AINULT cache1.sss v√µrgus!
# ‚ö†Ô∏è Arendaja masinas eba√µnnestub!
#
# ==========================================================================

FROM node:22-slim

# ‚ö†Ô∏è HARDCODED PROXY - EI T√ñ√ñTA arendaja masinas!
# See on p√µhjus #1, miks see on halb:
# - Kui sa oled Tallinna kontoris (cache1.sss v√µrk): ‚úÖ T√∂√∂tab
# - Kui sa oled kodus (avatud internet):           ‚ùå Ei t√∂√∂ta (connection timeout)
# - Kui kolleeg kloonib repo:                      ‚ùå Ei t√∂√∂ta tema masinas
ENV HTTP_PROXY=http://cache1.sss:3128 \
    HTTPS_PROXY=http://cache1.sss:3128 \
    NO_PROXY=localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16

# ‚ö†Ô∏è Proxy info on n√º√ºd KOGU image'is!
# See on p√µhjus #2, miks see on halb:
# - Runtime konteiner proovib kasutada cache1.sss:3128
# - Kui konteiner t√∂√∂tab AWS'is, GCP's, Azure'is ‚Üí ei t√∂√∂ta
# - V√µrgup√§ringud eba√µnnestuvad (rakendus crashib)
# - Debugging keeruline (miks runtime'is on proksi?)

WORKDIR /app

# npm install kasutab hardcoded HTTP_PROXY
COPY package*.json ./
RUN npm install --production

# Kopeeri kood
COPY . .

EXPOSE 3000

# ‚ö†Ô∏è PROXY on runtime'is ALLES (leak!)
# Testi: docker run --rm user-service:1.0-hardcoded env | grep PROXY
# N√§ed: HTTP_PROXY=http://cache1.sss:3128 ‚Üê See EI PEAKS olema runtime'is!

CMD ["node", "server.js"]

# ==========================================================================
# REFAKTORIMISE JUHEND:
# ==========================================================================
#
# Kui sa leiad corporate codebase'ist sellise Dockerfile'i, refaktori nii:
#
# SAMM 1: Asenda hardcoded ENV ARG'idega
# ----------------------------------------
# Eemalda:  ENV HTTP_PROXY=http://cache1.sss:3128
# Lisa:     ARG HTTP_PROXY=""
#           ENV HTTP_PROXY=${HTTP_PROXY}
#
# SAMM 2: Uuenda build k√§sud
# ---------------------------
# Build proksiga:
#   docker build --build-arg HTTP_PROXY=http://cache1.sss:3128 ...
#
# Build ilma:
#   docker build ...
#
# SAMM 3: Idealiter: multi-stage build
# -------------------------------------
# J√§rgi: Dockerfile.optimized.proxy pattern'i
# - Proxy ainult builder stage'is
# - Runtime clean (ei leki)
#
# SAMM 4: Uuenda CI/CD
# ---------------------
# - Lisa build-arg'id CI/CD secret'idesse
# - Testi m√µlemas keskkonnas (proxy + ilma)
#
# ==========================================================================
#
# CORPORATE SURVIVAL TIP:
# -----------------------
# Kui leiad sellise Dockerfile'i ja sulle √∂eldakse "don't touch it, it works":
#
# 1. Loo uus Dockerfile.optimized.proxy K√ïRVALE (√§ra muuda vana)
# 2. Testi p√µhjalikult
# 3. N√§ita erinevust (image size, portability, security)
# 4. Paku migreerimisplaani (deprecated vana ‚Üí uus)
# 5. Ole kannatlik (muutus v√µtab aega)
#
# ==========================================================================
#
# LINGID:
# -------
# üìñ √ïige lahendus: Dockerfile.optimized.proxy
# üìñ Dokumentatsioon: README-PROXY.md
# üìñ Teooria: ../../../../resource/06-Dockerfile-Rakenduste-Konteineriseerimise-Detailid.md
#
# ==========================================================================
