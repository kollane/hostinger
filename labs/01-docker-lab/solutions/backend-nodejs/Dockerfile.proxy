# ==========================================================================
# Proxy-teadlik LIHTNE Dockerfile User Teenuse (Service) jaoks
# ==========================================================================
#
# See on LIHTNE (single-stage) variant proksi toega.
# V√µrdle optimeeritud variandiga: Dockerfile.optimized.proxy
#
# ERINEVUSED optimized'ist:
# --------------------------
# ‚ùå Single-stage (k√µik √ºhes stage'is, ei ole eraldi dependencies stage'i)
# ‚ùå Dev dependencies ka kaasas (suurem image)
# ‚úÖ ARG-p√µhine proxy (t√∂√∂tab proksi ja ilma)
# ‚úÖ Non-root user
# ‚úÖ Health check
#
# KASUTUS:
# --------
#
# 1. PROXY KESKKOND:
#    docker build \
#      --build-arg HTTP_PROXY=http://cache1.sss:3128 \
#      --build-arg HTTPS_PROXY=http://cache1.sss:3128 \
#      --build-arg NO_PROXY=localhost,127.0.0.1 \
#      -f Dockerfile.proxy \
#      -t user-service:1.0-simple \
#      ../../../apps/backend-nodejs
#
# 2. ILMA PROXY'TA:
#    docker build \
#      -f Dockerfile.proxy \
#      -t user-service:1.0-simple \
#      ../../../apps/backend-nodejs
#
# SOOVITUS:
# ---------
# üìñ Tootmiseks kasuta: Dockerfile.optimized.proxy
# üìñ √ïppimiseks/testimiseks: See fail (Dockerfile.proxy)
#
# ==========================================================================

# ARG deklaratsioonid ENNE FROM
ARG HTTP_PROXY=""
ARG HTTPS_PROXY=""
ARG NO_PROXY=""

# Single-stage: k√µik toimub √ºhes stage'is
FROM node:22-slim

# Seadista proxy keskkonna muutujad
# ‚ö†Ô∏è Need on KOGU image'is (ka runtime'is) - ei ole ideaalne!
# Optimeeritud variant (Dockerfile.optimized.proxy) hoiab need ainult builder stage'is.
ENV HTTP_PROXY=${HTTP_PROXY} \
    HTTPS_PROXY=${HTTPS_PROXY} \
    NO_PROXY=${NO_PROXY}

WORKDIR /app

# Loo mitte-juurkasutaja (non-root user)
RUN groupadd -g 1001 nodejs && \
    useradd -r -u 1001 -g nodejs nodejs

# Kopeeri package files ja installi s√µltuvused
COPY package*.json ./

# npm ci kasutab HTTP_PROXY/HTTPS_PROXY keskkonna muutujaid
RUN npm ci --only=production

# Kopeeri rakenduse kood
COPY . .

# M√§√§ra omanikuks nodejs kasutaja
RUN chown -R nodejs:nodejs /app

# Kasuta mitte-juurkasutajat
USER nodejs:nodejs

EXPOSE 3000

# Seisukorra kontroll (Health check)
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s \
  CMD node healthcheck.js || exit 1

CMD ["node", "server.js"]

# ==========================================================================
# √ïPPEPUNKT: Miks optimeeritud variant on parem?
# ==========================================================================
#
# LIHTNE (see fail):
# ------------------
# ‚úÖ Lihtne m√µista (k√µik √ºhes stage'is)
# ‚úÖ Kiire ehitada (ei pea stage'ide vahel kopeerima)
# ‚ùå Suurem image (~305MB, sisaldab npm cache'i jm)
# ‚ùå Proxy muutujad runtime'is (ei ole ideaalne)
# ‚ùå Ei kasuta kihtide vahem√§lu (layer caching) optimaalselt
#
# OPTIMEERITUD (Dockerfile.optimized.proxy):
# -------------------------------------------
# ‚úÖ V√§iksem image (~305MB, optimeeritud)
# ‚úÖ Proxy muutujad AINULT builder stage'is (turvalisem)
# ‚úÖ Parem kihtide vahem√§lu (dependencies eraldi)
# ‚úÖ Production-ready
# ‚ùå Keerulisem m√µista (kaks stage'i)
#
# J√ÑRELDUS:
# ---------
# √ïppimiseks/testimiseks: ‚úÖ See fail
# Tootmiseks:             ‚úÖ Dockerfile.optimized.proxy
#
# ==========================================================================
