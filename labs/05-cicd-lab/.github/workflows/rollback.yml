# Rollback Workflow
#
# This workflow allows manual rollback of Kubernetes deployments.
# You can rollback to:
#   - Previous revision (default)
#   - Specific revision number
#
# Triggered by: Manual workflow_dispatch only

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      revision:
        description: 'Revision number (leave empty for previous revision)'
        required: false
        type: string

env:
  DEPLOYMENT_NAME: user-service

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Rollback Deployment
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  rollback:
    name: â®ï¸ Rollback to Revision
    runs-on: ubuntu-latest
    timeout-minutes: 10

    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ” Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: âœ… Verify cluster connection
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Cluster Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          kubectl cluster-info
          kubectl get nodes
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“œ Show current deployment status
        run: |
          ENV="${{ inputs.environment }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Current Deployment Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Current deployment
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

          echo ""
          echo "ğŸ–¼ï¸  Current Image:"
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV \
            -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""
          echo ""

          # Pods status
          echo "ğŸ“¦ Current Pods:"
          kubectl get pods -l app=${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

      - name: ğŸ“œ Show rollout history
        run: |
          ENV="${{ inputs.environment }}"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“œ Rollout History"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          kubectl rollout history deployment/${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

      - name: â®ï¸ Perform rollback
        run: |
          ENV="${{ inputs.environment }}"
          REVISION="${{ inputs.revision }}"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â®ï¸  Initiating Rollback"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -z "$REVISION" ]; then
            echo "â®ï¸  Rolling back to previous revision in $ENV..."
            kubectl rollout undo deployment/${{ env.DEPLOYMENT_NAME }} --namespace=$ENV
          else
            echo "â®ï¸  Rolling back to revision $REVISION in $ENV..."
            kubectl rollout undo deployment/${{ env.DEPLOYMENT_NAME }} \
              --namespace=$ENV \
              --to-revision=$REVISION
          fi

      - name: â³ Wait for rollback to complete
        run: |
          ENV="${{ inputs.environment }}"

          echo "â³ Waiting for rollback to complete..."

          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} \
            --namespace=$ENV \
            --timeout=5m

          echo "âœ… Rollback completed successfully in $ENV"

      - name: ğŸ“Š Verify rollback
        run: |
          ENV="${{ inputs.environment }}"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Post-Rollback Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Deployment status
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

          echo ""
          echo "ğŸ–¼ï¸  Current Image (after rollback):"
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV \
            -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""
          echo ""

          # Pods status
          echo "ğŸ“¦ Pods Status:"
          kubectl get pods -l app=${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

          echo ""
          echo "ğŸ“œ Updated Rollout History:"
          kubectl rollout history deployment/${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

      - name: ğŸ¥ Health check
        run: |
          ENV="${{ inputs.environment }}"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ Post-Rollback Health Check"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Port forward
          kubectl port-forward deployment/${{ env.DEPLOYMENT_NAME }} 3000:3000 --namespace=$ENV &
          PID=$!

          # Wait for port forward
          sleep 5

          # Health check with retry
          MAX_RETRIES=3
          RETRY=0

          while [ $RETRY -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "000")

            if [ "$HTTP_CODE" == "200" ]; then
              echo "âœ… Health check passed (HTTP $HTTP_CODE)"
              kill $PID
              exit 0
            fi

            RETRY=$((RETRY+1))
            echo "âš ï¸  Health check failed (HTTP $HTTP_CODE), retry $RETRY/$MAX_RETRIES..."
            sleep 3
          done

          # Kill port forward
          kill $PID

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "âš ï¸  Warning: Rollback completed but health check failed"
          exit 1

      - name: ğŸ“ Rollback summary
        if: always()
        run: |
          ENV="${{ inputs.environment }}"
          REVISION="${{ inputs.revision }}"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "           â®ï¸  Rollback Summary                       "
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment:      $ENV"

          if [ -z "$REVISION" ]; then
            echo "ğŸ”„ Rollback Type:    Previous revision"
          else
            echo "ğŸ”„ Rollback Type:    Specific revision ($REVISION)"
          fi

          echo "ğŸ“¦ Current Image:    $(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV -o jsonpath='{.spec.template.spec.containers[0].image}')"
          echo "ğŸ”¢ Replicas:         $(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV -o jsonpath='{.spec.replicas}')"
          echo "âœ… Available:        $(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV -o jsonpath='{.status.availableReplicas}')"
          echo "ğŸ• Timestamp:        $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ Triggered by:     ${{ github.actor }}"
          echo "ğŸ”— Workflow:         ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¢ Send notification (optional)
        if: always()
        run: |
          ENV="${{ inputs.environment }}"
          STATUS="${{ job.status }}"

          echo "ğŸ“¢ Rollback notification:"
          echo "   Environment: $ENV"
          echo "   Status: $STATUS"
          echo "   Triggered by: ${{ github.actor }}"

          # TODO: Add Slack/Discord webhook notification here
          # Example:
          # curl -X POST $SLACK_WEBHOOK_URL \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"Rollback in '"$ENV"' completed with status: '"$STATUS"'"}'
