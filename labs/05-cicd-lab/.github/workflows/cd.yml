# Continuous Deployment Workflow
#
# This workflow deploys to Kubernetes clusters based on branch:
#   - develop â†’ development environment (auto-deploy)
#   - staging â†’ staging environment (auto-deploy)
#   - main    â†’ production environment (manual approval required)
#
# Triggered by:
#   - Successful CI workflow completion
#   - Manual workflow_dispatch

name: Continuous Deployment

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches:
      - main
      - develop
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      image_tag:
        description: 'Image tag (default: branch-SHA)'
        required: false
        type: string

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/user-service
  DEPLOYMENT_NAME: user-service

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Determine Environment
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  determine-environment:
    name: ğŸ¯ Determine Environment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Determine environment and image tag
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger
            ENV="${{ inputs.environment }}"
            if [[ -n "${{ inputs.image_tag }}" ]]; then
              TAG="${{ inputs.image_tag }}"
            else
              TAG="${{ github.ref_name }}-${{ github.sha }}"
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="production"
            TAG="main-${{ github.sha }}"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            ENV="staging"
            TAG="staging-${{ github.sha }}"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENV="development"
            TAG="develop-${{ github.sha }}"
          else
            echo "âŒ Unknown branch: ${{ github.ref }}"
            exit 1
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Target Environment: $ENV"
          echo "ğŸ·ï¸  Image Tag: $TAG"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Deploy to Kubernetes
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deploy:
    name: ğŸš€ Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: determine-environment
    timeout-minutes: 10

    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: https://${{ needs.determine-environment.outputs.environment }}.example.com

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ” Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: âœ… Verify cluster connection
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Cluster Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          kubectl cluster-info
          kubectl get nodes
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸš€ Deploy to Kubernetes
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          TAG="${{ needs.determine-environment.outputs.image_tag }}"
          REPLICAS="${{ secrets.REPLICAS || 2 }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deploying to $ENV"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Image: ${{ env.IMAGE_NAME }}:$TAG"
          echo "ğŸ”¢ Replicas: $REPLICAS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Update deployment image
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            ${{ env.DEPLOYMENT_NAME }}=${{ env.IMAGE_NAME }}:$TAG \
            --namespace=$ENV \
            --record

          # Scale to environment-specific replicas
          kubectl scale deployment/${{ env.DEPLOYMENT_NAME }} \
            --replicas=$REPLICAS \
            --namespace=$ENV

      - name: â³ Wait for rollout
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"

          echo "â³ Waiting for rollout to complete..."
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} \
            --namespace=$ENV \
            --timeout=5m

          echo "âœ… Rollout completed successfully in $ENV"

      - name: ğŸ“Š Verify deployment
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Deployment Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

          echo ""
          echo "ğŸ“¦ Pods:"
          kubectl get pods -l app=${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

          echo ""
          echo "ğŸ–¼ï¸  Current Image:"
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV \
            -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""

      - name: ğŸ¥ Health check
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"

          echo "ğŸ¥ Performing health check..."

          # Port forward to deployment
          kubectl port-forward deployment/${{ env.DEPLOYMENT_NAME }} 3000:3000 --namespace=$ENV &
          PID=$!

          # Wait for port forward to be ready
          sleep 5

          # Perform health check with retry
          MAX_RETRIES=3
          RETRY=0

          while [ $RETRY -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "000")

            if [ "$HTTP_CODE" == "200" ]; then
              echo "âœ… Health check passed (HTTP $HTTP_CODE)"
              kill $PID
              exit 0
            fi

            RETRY=$((RETRY+1))
            echo "âš ï¸  Health check failed (HTTP $HTTP_CODE), retry $RETRY/$MAX_RETRIES..."
            sleep 3
          done

          # Kill port forward
          kill $PID

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: ğŸ“ Deployment summary
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          TAG="${{ needs.determine-environment.outputs.image_tag }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "           ğŸ‰ Deployment Successful!                  "
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment:  $ENV"
          echo "ğŸ“¦ Image:        ${{ env.IMAGE_NAME }}:$TAG"
          echo "ğŸ”¢ Replicas:     $(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV -o jsonpath='{.spec.replicas}')"
          echo "âœ… Available:    $(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} --namespace=$ENV -o jsonpath='{.status.availableReplicas}')"
          echo "ğŸ• Timestamp:    $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow:     ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: â®ï¸ Rollback on failure
        if: failure()
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment failed, rolling back..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          kubectl rollout undo deployment/${{ env.DEPLOYMENT_NAME }} --namespace=$ENV
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --namespace=$ENV

          echo "âœ… Rollback completed"
