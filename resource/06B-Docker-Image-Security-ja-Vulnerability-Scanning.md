# Peat√ºkk 06B: Docker Image Security ja Vulnerability Scanning

**Kestus:** 2-3 tundi lugemist ja praktiseerimist
**Eeldused:** Peat√ºkk 06 (Dockerfile), Peat√ºkk 06A (Java/Node.js spetsiifika)
**√ïpieesm√§rgid:** M√µista Docker image'i turvariske, √µppida kasutama vulnerability scannereid (Docker Scout, Trivy), rakendada security best practices

---

## üìã Sisukord

1. [Sissejuhatus](#sissejuhatus)
2. [CVE ja CVSS Skoorid](#cve-ja-cvss-skoorid)
3. [Docker Scout](#docker-scout)
4. [Trivy](#trivy)
5. [Security Best Practices](#security-best-practices)
6. [CI/CD Integratsioon](#cicd-integratsioon)
7. [Praktiline N√§ide](#praktiline-n√§ide)
8. [Kokkuv√µte](#kokkuv√µte)

---

## Sissejuhatus

### Miks Docker Image Security On Oluline?

Docker image v√µib sisaldada:
- **Turvaaukudega (vulnerable) baaspilte (base images)** - Ubuntu, Alpine, Node.js, Java
- **Turvaaukudega s√µltuvusi (dependencies)** - npm paketid, Maven/Gradle teegid
- **Vananenud (outdated) versioone** - tarkvarapaketid, mida ei ole uuendatud
- **Tundlikke andmeid (sensitive data)** - paroolid, API v√µtmed, sertifikaadid

**Tagaj√§rjed:**
- ‚ùå Remote Code Execution (RCE) - r√ºndaja saab koodi t√§ita
- ‚ùå Privilege Escalation - kasutaja saab root √µigused
- ‚ùå Data Breach - andmete lekkimine
- ‚ùå Denial of Service (DoS) - teenuse k√§ttesaamatus

**Lahendus: Regulaarne Vulnerability Scanning**
- ‚úÖ Tuvasta turvaaugud (vulnerabilities) enne production'i
- ‚úÖ Uuenda baaspilte (base images) ja s√µltuvusi (dependencies)
- ‚úÖ Automaatne skannimine CI/CD pipeline'is
- ‚úÖ J√§rgi security best practices (non-root users, minimal images)

---

## CVE ja CVSS Skoorid

### Mis on CVE?

**CVE (Common Vulnerabilities and Exposures)** - standardiseeritud andmebaas tuntud turvaaukudest.

**CVE ID formaat:** `CVE-YYYY-NNNNN`
- `YYYY` - aasta (nt. 2024, 2025)
- `NNNNN` - unikaalne number (nt. 12345)

**N√§ide:** `CVE-2024-3094` - XZ Utils backdoor (m√§rts 2024)

**CVE sisaldab:**
- **Kirjeldus** - mida turvaaugugu teeb
- **M√µjutatud versioonid** - millised tarkvaraversioonid on haavatavad
- **CVSS skoor** - raskusaste (severity)
- **Parandus (fix)** - kuidas probleem lahendada (tavaliselt: uuenda versioonile X.Y.Z)

### CVSS (Common Vulnerability Scoring System)

**CVSS skoor:** 0.0 - 10.0 (madal ‚Üí k√µrge)

| Skoor | Severity | Kirjeldus | Tegevus |
|-------|----------|-----------|---------|
| **0.1-3.9** | LOW | V√§ike risk, raske √§rakasutada | Monitor, uuenda kui mugav |
| **4.0-6.9** | MEDIUM | Keskmine risk, v√µimalik √§rakasutada | Uuenda 30 p√§eva jooksul |
| **7.0-8.9** | HIGH | K√µrge risk, lihtne √§rakasutada | Uuenda 7 p√§eva jooksul |
| **9.0-10.0** | CRITICAL | Kriitiline risk, aktiivne √§rakasutamine | Uuenda KOHE (24h) |

**N√§ited:**

```
CVE-2024-12345: OpenSSL Remote Code Execution
CVSS: 9.8 (CRITICAL)
M√µju: R√ºndaja saab t√§ita suvaline kood serveris
Parandus: Uuenda OpenSSL 1.1.1w ‚Üí 3.0.12
```

```
CVE-2024-23456: Node.js Denial of Service
CVSS: 7.5 (HIGH)
M√µju: Spetsiaalset crafted request'i saab kasutada DoS'i jaoks
Parandus: Uuenda Node.js 18.x ‚Üí 18.19.1 v√µi 20.x ‚Üí 20.11.1
```

---

## Docker Scout

### Mis on Docker Scout?

**Docker Scout** on Docker'i ametlik vulnerability skanner, mis on vaikimisi saadaval:
- ‚úÖ Docker Desktop'is (GUI)
- ‚úÖ Docker CLI's (k√§surea)
- ‚úÖ Docker Hub'is (web'is)

**Eelised:**
- ‚úÖ Sisseehitatud (no installation needed)
- ‚úÖ Kiire (scannib image layer'eid)
- ‚úÖ Soovitused (recommendations) base image uuendamiseks
- ‚úÖ V√µrdlus (compare) kahe versiooni vahel

### Docker Scout P√µhik√§sud

#### 1. Skanni Docker Image'it

```bash
# Skanni kohalikku image'it
docker scout cves user-service:1.0

# Skanni konkreetset registry image'it
docker scout cves nginx:latest

# Skanni ainult HIGH ja CRITICAL
docker scout cves --only-severity high,critical user-service:1.0
```

**N√§idis v√§ljund:**

```
‚úó HIGH CVE-2024-1234 [pkg:npm/express@4.17.1]
  Affected range : >=4.0.0 <4.18.3
  Fixed version  : 4.18.3
  CVSS Score     : 7.5
  CVSS Vector    : CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H

‚úó CRITICAL CVE-2024-5678 [pkg:deb/ubuntu/openssl@3.0.2-0ubuntu1.10]
  Affected range : >=3.0.0 <3.0.13
  Fixed version  : 3.0.13-0ubuntu1.11
  CVSS Score     : 9.8
  CVSS Vector    : CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
```

**V√§ljundi t√µlgendamine:**
- **‚úó** - turvaauguga (vulnerable)
- **HIGH/CRITICAL** - raskusaste (severity)
- **CVE ID** - CVE identifikaator
- **Package** - m√µjutatud pakett (npm, deb, apk, jne)
- **Affected range** - haavatavad versioonid
- **Fixed version** - parandatud versioon
- **CVSS Score** - CVSS skoor (0-10)
- **CVSS Vector** - CVSS vektor (attack vector, complexity, privileges, jne)

#### 2. V√µrdle Kahe Image'i Vahel

```bash
# V√µrdle vana vs uus versioon
docker scout compare user-service:1.0 --to user-service:1.0-optimized

# Oodatud v√§ljund:
#   user-service:1.0           : 15 vulnerabilities (5 HIGH, 2 CRITICAL)
#   user-service:1.0-optimized : 8 vulnerabilities (2 HIGH, 0 CRITICAL)
#   Improvement: -7 vulnerabilities (-3 HIGH, -2 CRITICAL)
```

**Kasutus:**
- ‚úÖ Veendu, et uus versioon on turvalisem
- ‚úÖ N√§e, kas base image uuendamine aitas
- ‚úÖ J√§lgi progress'i (improvement) aja jooksul

#### 3. Soovitused (Recommendations)

```bash
# N√§ita soovitusi
docker scout recommendations user-service:1.0

# Oodatud v√§ljund:
# - Update base image from node:18.17.0 to node:18.19.1 (fixes 5 CVEs)
# - Update npm dependency express from 4.17.1 to 4.18.3 (fixes CVE-2024-1234)
# - Update apt package openssl from 3.0.2 to 3.0.13 (fixes CVE-2024-5678)
```

**Tegevused:**
1. Uuenda baaspilt (base image) Dockerfile'is: `FROM node:18.19.1-slim`
2. Uuenda npm s√µltuvused (dependencies): `npm update express`
3. Rebuild image: `docker build -t user-service:1.0-fixed .`
4. Skanni uuesti: `docker scout cves user-service:1.0-fixed`

#### 4. Kiire √úlevaade (Quick Summary)

```bash
# Kiire √ºlevaade
docker scout quickview user-service:1.0

# Oodatud v√§ljund:
#   Image: user-service:1.0
#   Platform: linux/amd64
#   Size: 305 MB
#   Vulnerabilities: 15 total (2 CRITICAL, 5 HIGH, 6 MEDIUM, 2 LOW)
#   Base image: node:18.17.0-slim (outdated, recommend: node:18.19.1-slim)
```

### Docker Scout Web UI

**Docker Hub integratsioon:**
1. Ava https://hub.docker.com
2. Login oma Docker Hub kontoga
3. Vali image (nt. `myorg/user-service:1.0`)
4. Vaata **"Security"** tab'i
5. N√§ed graafikut: vulnerability trends, severity breakdown, recommendations

**Eelised:**
- ‚úÖ Visualiseeritud (charts, graphs)
- ‚úÖ History (n√§ed trendi aja jooksul)
- ‚úÖ Sharing (jaga tiimiga)

---

## Trivy

### Mis on Trivy?

**Trivy** on Aqua Security poolt loodud avatud l√§htekoodiga (open-source) vulnerability skanner.

**V√µrreldes Docker Scout'iga:**
- ‚úÖ P√µhjalikum (scannib rohkem: OS packages, language dependencies, IaC, secrets)
- ‚úÖ Rohkem formaate (JSON, SARIF, HTML, Markdown)
- ‚úÖ CI/CD integratsioon (GitHub Actions, GitLab CI, jne)
- ‚úÖ Secrets detection (API keys, passwords)
- ‚ùå Vajab installimist (mitte sisseehitatud)

### Trivy Installimine

#### Variant A: Lokaalne Binaar (Ubuntu/Debian)

```bash
# Lisa Trivy repository
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list

# Installi
sudo apt update
sudo apt install trivy

# Kontrolli versiooni
trivy --version
# Oodatud: Trivy 0.48.0 (v√µi uuem)
```

#### Variant B: macOS (Homebrew)

```bash
brew install trivy

# Kontrolli versiooni
trivy --version
```

#### Variant C: Docker Konteiner (Cross-platform)

```bash
# Kasuta Trivy'd l√§bi Docker'i (ei vaja installimist!)
docker run --rm \
  -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy:latest image user-service:1.0

# Selgitus:
# --rm                              - Kustuta konteiner p√§rast t√∂√∂ l√µppu
# -v /var/run/docker.sock:...      - Mount Docker socket (et Trivy n√§eks hosti image'eid)
# aquasec/trivy:latest             - Trivy image
# image user-service:1.0           - Skanni hosti image'it
```

**Millal kasutada Docker varianti?**
- ‚úÖ CI/CD pipeline'is (ei vaja binaar installimist)
- ‚úÖ Build node'd peavad olema "puhtad"
- ‚úÖ Mitme projekti jaoks sama Trivy versioon
- ‚úÖ Cross-platform (t√∂√∂tab Windows/Mac/Linux'il)

### Trivy P√µhik√§sud (Lokaalne Binaar)

#### 1. Skanni Docker Image'it

```bash
# Skanni k√µiki vulnerabilities
trivy image user-service:1.0

# Skanni ainult HIGH ja CRITICAL
trivy image --severity HIGH,CRITICAL user-service:1.0

# Oodatud v√§ljund:
# user-service:1.0 (ubuntu 22.04)
# ================================
# Total: 15 (HIGH: 5, CRITICAL: 2)
#
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ   Library    ‚îÇ Vulnerability ‚îÇ Severity ‚îÇ Installed Ver.  ‚îÇ  Fixed Ver.   ‚îÇ               Title                  ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ openssl      ‚îÇ CVE-2024-5678 ‚îÇ CRITICAL ‚îÇ 3.0.2-0ubuntu1  ‚îÇ 3.0.13        ‚îÇ OpenSSL: Remote Code Execution       ‚îÇ
# ‚îÇ express      ‚îÇ CVE-2024-1234 ‚îÇ HIGH     ‚îÇ 4.17.1          ‚îÇ 4.18.3        ‚îÇ Express: Denial of Service           ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**V√§ljundi t√µlgendamine:**
- **Library** - m√µjutatud teek (openssl, express, jne)
- **Vulnerability** - CVE ID
- **Severity** - raskusaste (LOW, MEDIUM, HIGH, CRITICAL)
- **Installed Version** - hetkel installitud versioon
- **Fixed Version** - parandatud versioon
- **Title** - turvaaugugu kirjeldus

#### 2. Skanni OS Pakette JA Language Dependencies

```bash
# Skanni AINULT OS pakette (apt, apk, yum)
trivy image --vuln-type os user-service:1.0

# Skanni AINULT language dependencies (npm, maven, pip)
trivy image --vuln-type library user-service:1.0

# Skanni M√ïLEMAT (default)
trivy image user-service:1.0
```

**Miks eraldi?**
- **OS paketid** - Uuenda baaspilt (base image): `FROM node:18.19.1-slim`
- **Language dependencies** - Uuenda `package.json` v√µi `build.gradle`

#### 3. Genereeri JSON Raport

```bash
# JSON formaat
trivy image --format json --output user-service-scan.json user-service:1.0

# Vaata JSON'i
cat user-service-scan.json | jq '.Results[0].Vulnerabilities[] | {ID: .VulnerabilityID, Severity: .Severity, Package: .PkgName}'

# Oodatud v√§ljund:
# {
#   "ID": "CVE-2024-5678",
#   "Severity": "CRITICAL",
#   "Package": "openssl"
# }
# {
#   "ID": "CVE-2024-1234",
#   "Severity": "HIGH",
#   "Package": "express"
# }
```

**JSON kasutus:**
- ‚úÖ CI/CD integratsioon (parse JSON, fail kui CRITICAL > 0)
- ‚úÖ Dashboard'id (Grafana, Kibana)
- ‚úÖ Aruanded (reports) juhtkonnale

#### 4. HTML Raport (Visualiseeritud)

```bash
# Genereeri HTML raport
trivy image --format template --template "@contrib/html.tpl" --output user-service-report.html user-service:1.0

# Ava browser'is
xdg-open user-service-report.html  # Linux
open user-service-report.html       # macOS
```

**HTML raport sisaldab:**
- üìä Pie chart (severity breakdown)
- üìã Tabel (k√µik vulnerabilities)
- üîó Lingid CVE detailidele (NIST, NVD)

#### 5. V√µrdle Kahe Versiooni Vahel

```bash
# Skanni vana versioon
trivy image user-service:1.0 > vana.txt

# Skanni uus versioon
trivy image user-service:1.0-optimized > uus.txt

# V√µrdle
diff vana.txt uus.txt

# Oodatud:
# - CVE-2024-5678 (CRITICAL) - openssl 3.0.2 ‚Üí 3.0.13 (FIXED!)
# - CVE-2024-1234 (HIGH) - express 4.17.1 ‚Üí 4.18.3 (FIXED!)
```

### Trivy P√µhik√§sud (Docker Konteiner)

#### √úhekordne Skannimine

```bash
# Skanni HIGH ja CRITICAL
docker run --rm \
  -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy:latest image \
  --severity HIGH,CRITICAL user-service:1.0
```

#### JSON Raport

```bash
# Genereeri JSON raport (salvesta hosti)
docker run --rm \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v "$(pwd)":/reports \
  aquasec/trivy:latest image \
  --format json --output /reports/user-service-scan.json \
  user-service:1.0

# Kontrolli
ls -lh user-service-scan.json
cat user-service-scan.json | jq '.Results[0].Vulnerabilities | length'
# Oodatud: 15 (vulnerabilities arv)
```

#### V√µrdlus

```bash
# Vana versioon
docker run --rm \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v "$(pwd)":/reports \
  aquasec/trivy:latest image user-service:1.0 > vana.txt

# Uus versioon
docker run --rm \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v "$(pwd)":/reports \
  aquasec/trivy:latest image user-service:1.0-optimized > uus.txt

# V√µrdle
diff vana.txt uus.txt
```

---

## Security Best Practices

### 1. Non-Root Users

**Probleem:** Docker konteinerid t√∂√∂tavad vaikimisi **root'ina** (UID 0).

**Risk:**
- ‚ùå Kui r√ºndaja saab konteineri √ºle, on tal root √µigused
- ‚ùå Container escape ‚Üí host kompromiteeritud
- ‚ùå Privilege escalation lihtsam

**Lahendus: Loo non-root user Dockerfile'is**

#### Node.js N√§ide (Debian/Ubuntu base)

```dockerfile
FROM node:18-slim

WORKDIR /app

# Loo non-root user ja grupp
RUN groupadd -g 1001 nodejs && \
    useradd -r -u 1001 -g nodejs nodejs

# Kopeeri failid ja m√§√§ra ownership
COPY --chown=nodejs:nodejs package*.json ./
RUN npm ci --only=production
COPY --chown=nodejs:nodejs . .

# Switch to non-root user
USER nodejs:nodejs

EXPOSE 3000
CMD ["node", "server.js"]
```

**Selgitus:**
- `groupadd -g 1001 nodejs` - Loo grupp ID 1001 nimega "nodejs"
- `useradd -r -u 1001 -g nodejs nodejs` - Loo kasutaja ID 1001 nimega "nodejs", grupis "nodejs"
- `--chown=nodejs:nodejs` - M√§√§ra failide omanik (owner) nodejs kasutajaks
- `USER nodejs:nodejs` - K√§ivita rakendus non-root'ina

#### Java N√§ide (Alpine base)

```dockerfile
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

# Loo non-root user (Alpine k√§sud!)
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001 -G spring

# Kopeeri JAR ja m√§√§ra ownership
COPY --from=builder --chown=spring:spring /app/build/libs/app.jar app.jar

# Switch to non-root user
USER spring:spring

EXPOSE 8081
CMD ["java", "-jar", "app.jar"]
```

**Selgitus:**
- `addgroup -g 1001 -S spring` - Loo grupp ID 1001 nimega "spring" (Alpine syntax)
- `adduser -S spring -u 1001 -G spring` - Loo kasutaja ID 1001 nimega "spring", grupis "spring"
- `USER spring:spring` - K√§ivita rakendus non-root'ina

**Kontrolli:**

```bash
# Kontrolli, kes k√§ivitab protsessi
docker exec user-service id
# Oodatud: uid=1001(nodejs) gid=1001(nodejs) groups=1001(nodejs)

# Kontrolli, et mitte root
docker exec user-service whoami
# Oodatud: nodejs (mitte root!)
```

### 2. Minimal Base Images

**Probleem:** Suured base image'd (ubuntu:22.04, debian:12) sisaldavad palju tarbetuid pakette.

**Risk:**
- ‚ùå Rohkem pakette = rohkem CVE'd
- ‚ùå Suurem attack surface (r√ºnnaku pindala)
- ‚ùå Aeglasem deploy (suurem image)

**Lahendus: Kasuta minimalistlikke base image'eid**

#### Alpine Linux

```dockerfile
# Enne: 150MB, 50 vulnerabilities
FROM node:18

# P√§rast: 50MB, 15 vulnerabilities
FROM node:18-alpine
```

**Eelised:**
- ‚úÖ V√§ike (5-50MB vs 100-200MB)
- ‚úÖ V√§hem pakette = v√§hem CVE'd
- ‚úÖ Kiirem deploy

**Miinused:**
- ‚ùå Kasutab musl libc (mitte glibc) ‚Üí √ºhilduvuse probleemid native moodulitega (nt. bcrypt, sharp)
- ‚ùå V√§hem pakette alpine repo's
- ‚ùå Debuggimine raskem (v√§hem t√∂√∂riistu)

#### Distroless Images (Google)

```dockerfile
# Enne: 230MB, 40 vulnerabilities
FROM eclipse-temurin:21-jre

# P√§rast: 180MB, 10 vulnerabilities
FROM gcr.io/distroless/java21-debian12
COPY --from=builder /app/build/libs/app.jar /app.jar
CMD ["java", "-jar", "/app.jar"]
```

**Eelised:**
- ‚úÖ AINULT runtime dependencies (Java JRE, mitte shell, package manager)
- ‚úÖ Minimal attack surface
- ‚úÖ V√§ga v√§he CVE'd

**Miinused:**
- ‚ùå Ei ole shell'i (sh, bash) ‚Üí ei saa `docker exec -it container sh`
- ‚ùå Debuggimine keeruline
- ‚ùå Ainult Java, Node.js, Python, Go (piiratud valik)

**Soovitus:**
- ‚úÖ **Development:** kasuta `-slim` (nt. `node:18-slim`) - hea tasakaal size vs functionality
- ‚úÖ **Production:** kasuta `-alpine` v√µi `distroless` - minimaalne attack surface

### 3. Read-Only Root Filesystem

**Probleem:** R√ºndaja saab kirjutada failis√ºsteemi (write files), installida malware.

**Lahendus: Tee root filesystem read-only**

```bash
# Docker run'iga
docker run --read-only -d --name user-service \
  -v /app/tmp:/tmp \
  -v /app/logs:/app/logs \
  user-service:1.0

# Selgitus:
# --read-only            - Root filesystem on read-only
# -v /app/tmp:/tmp       - Mount writable volume /tmp jaoks (temporary files)
# -v /app/logs:/app/logs - Mount writable volume logide jaoks
```

**Kubernetes manifest:**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: user-service
spec:
  containers:
  - name: user-service
    image: user-service:1.0
    securityContext:
      readOnlyRootFilesystem: true
    volumeMounts:
    - name: tmp
      mountPath: /tmp
    - name: logs
      mountPath: /app/logs
  volumes:
  - name: tmp
    emptyDir: {}
  - name: logs
    emptyDir: {}
```

**Eelised:**
- ‚úÖ R√ºndaja ei saa malware installida
- ‚úÖ Rakendus ei saa muuta enda koodi (code tampering)

**Miinused:**
- ‚ùå Vajab writable volume'eid /tmp ja log failide jaoks
- ‚ùå M√µned rakendused ei t√∂√∂ta read-only filesystem'iga

### 4. Health Checks

**Probleem:** Kui rakendus hangub (hangs), Docker ei tea sellest.

**Lahendus: Lisa HEALTHCHECK Dockerfile'i**

#### Node.js Healthcheck

```dockerfile
# Dockerfile
FROM node:18-slim
WORKDIR /app

# ... rakenduse setup ...

# Healthcheck script
COPY healthcheck.js .

# Healthcheck (iga 30s, timeout 3s, start grace period 10s)
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s \
  CMD node healthcheck.js || exit 1

CMD ["node", "server.js"]
```

**healthcheck.js:**

```javascript
const http = require('http');

const options = {
  host: 'localhost',
  port: 3000,
  path: '/health',
  timeout: 2000
};

const req = http.request(options, (res) => {
  if (res.statusCode === 200) {
    process.exit(0); // Healthy
  } else {
    process.exit(1); // Unhealthy
  }
});

req.on('error', () => process.exit(1)); // Unhealthy
req.end();
```

#### Java Spring Boot Healthcheck

```dockerfile
# Dockerfile
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app

# ... rakenduse setup ...

# Healthcheck (iga 30s, timeout 3s, start grace period 40s - Spring Boot k√§ivitub aeglasemalt)
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8081/health || exit 1

CMD ["java", "-jar", "app.jar"]
```

**Spring Boot /health endpoint (automaatne):**

```java
// Spring Boot Actuator pakub /health endpoint'i automaatselt
// Ainult lisa dependency:
// implementation 'org.springframework.boot:spring-boot-starter-actuator'
```

**Kontrolli:**

```bash
# Vaata container health status
docker ps --format "table {{.Names}}\t{{.Status}}"

# Oodatud:
# NAMES          STATUS
# user-service   Up 2 minutes (healthy)
# todo-service   Up 2 minutes (healthy)

# Kui unhealthy:
# user-service   Up 2 minutes (unhealthy)

# Vaata healthcheck logisid
docker inspect user-service | jq '.[0].State.Health'
```

**Kubernetes Liveness/Readiness Probes:**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: user-service
spec:
  containers:
  - name: user-service
    image: user-service:1.0
    ports:
    - containerPort: 3000
    livenessProbe:
      httpGet:
        path: /health
        port: 3000
      initialDelaySeconds: 10
      periodSeconds: 30
      timeoutSeconds: 3
    readinessProbe:
      httpGet:
        path: /health
        port: 3000
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 3
```

**Eelised:**
- ‚úÖ Automaatne restart kui rakendus hangub
- ‚úÖ Kubernetes/Docker Compose kasutavad health status'it load balancing'uks
- ‚úÖ Monitoring (Prometheus) saab health status'it j√§lgida

### 5. Base Image Uuendamise Strateegia

**Probleem:** Base image'd vananevad kiiresti, uued CVE'd ilmuvad iga n√§dal.

**Lahendus: Automaatne uuendamine**

#### Strateegia 1: Latest Stable Tag (Soovitatav)

```dockerfile
# ‚ùå MITTE pinned version (ei uuendata automaatselt)
FROM node:18.17.0-slim

# ‚úÖ Latest stable minor version (automaatsed patch uuendused)
FROM node:18-slim

# Selgitus:
# node:18-slim = node:18.x.y-slim (kus y on k√µige uuem patch versioon)
# Docker Hub uuendab automaatselt tag'i kui uus patch ilmub
# Rebuild ‚Üí saad automaatselt node:18.19.1-slim (kui see on uusim)
```

**Eelised:**
- ‚úÖ Automaatsed security patch'id (rebuild ‚Üí uus versioon)
- ‚úÖ Breaking change'e pole (sama minor version)
- ‚úÖ Lihtne

**Miinused:**
- ‚ùå Rebuild on vajalik (ei uuendata automaatselt running containers)
- ‚ùå Peab usaldama upstream'i (Docker Hub)

#### Strateegia 2: Renovate Bot (GitHub/GitLab)

**Renovate Bot** - automaatne dependency uuendaja.

**.github/renovate.json:**

```json
{
  "extends": ["config:base"],
  "docker": {
    "enabled": true,
    "pinDigests": false
  },
  "schedule": ["before 6am on monday"],
  "vulnerabilityAlerts": {
    "enabled": true
  }
}
```

**Kuidas t√∂√∂tab:**
1. Renovate skannib Dockerfile'e
2. Kui uus base image ilmub, loob automaatse PR'i
3. CI/CD testib (build, test, security scan)
4. Kui testid l√§bivad, mergida PR

**Eelised:**
- ‚úÖ T√§ielik automatiseerimine (no manual work)
- ‚úÖ Testitud enne merge'i (CI/CD)
- ‚úÖ N√§ed changelog'i (mis muutus)

#### Strateegia 3: Dependabot (GitHub)

**.github/dependabot.yml:**

```yaml
version: 2
updates:
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 5
```

**Kuidas t√∂√∂tab:**
- Sama nagu Renovate, aga GitHub native
- Automaatsed PR'id base image uuendusteks

---

## CI/CD Integratsioon

### GitHub Actions N√§ide

**.github/workflows/security-scan.yml:**

```yaml
name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1' # Igal esmasp√§eval kell 02:00

jobs:
  docker-scout:
    name: Docker Scout Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t user-service:${{ github.sha }} ./apps/backend-nodejs

      - name: Run Docker Scout
        uses: docker/scout-action@v1
        with:
          command: cves
          image: user-service:${{ github.sha }}
          only-severities: high,critical
          exit-code: true  # Fail kui HIGH/CRITICAL CVE'd

      - name: Scout recommendations
        run: |
          docker scout recommendations user-service:${{ github.sha }}

  trivy:
    name: Trivy Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t user-service:${{ github.sha }} ./apps/backend-nodejs

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: user-service:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'  # Fail kui HIGH/CRITICAL CVE'd

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Generate HTML report
        if: always()
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}:/reports \
            aquasec/trivy:latest image \
            --format template --template "@contrib/html.tpl" \
            --output /reports/trivy-report.html \
            user-service:${{ github.sha }}

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report
          path: trivy-report.html
```

**Selgitus:**
- **on.push/pull_request** - Skanni iga commit/PR peale
- **on.schedule** - Skanni kord n√§dalas (uued CVE'd v√µivad ilmuda)
- **exit-code: 1** - Fail build kui HIGH/CRITICAL CVE'd
- **upload-sarif** - Integreeri GitHub Security tab'iga
- **upload-artifact** - Salvesta HTML raport (saab alla laadida)

**Tulemused:**
- ‚úÖ Pull Request failibki HIGH/CRITICAL CVE'd
- ‚úÖ GitHub Security tab n√§itab k√µiki vulnerabilities
- ‚úÖ HTML raport artifact'ina (allalaaditav)

### GitLab CI N√§ide

**.gitlab-ci.yml:**

```yaml
stages:
  - build
  - security

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA ./apps/backend-nodejs
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

trivy:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --severity HIGH,CRITICAL --exit-code 1 $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  allow_failure: false

docker-scout:
  stage: security
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker scout cves --only-severity high,critical --exit-code 1 $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  allow_failure: false
```

---

## Praktiline N√§ide

### User Service ja Todo Service Skannimine

#### Eeldused

```bash
# Build m√µlemad image'd (kui pole veel)
cd apps/backend-nodejs
docker build -t user-service:1.0 .

cd ../backend-java-spring
./gradlew clean bootJar
docker build -t todo-service:1.0 .
```

#### Samm 1: Docker Scout Scan

```bash
# === USER SERVICE ===
echo "=== User Service Security Scan (Docker Scout) ==="
docker scout cves user-service:1.0

# Oodatud v√§ljund:
# ‚úó HIGH CVE-2024-1234 [pkg:npm/express@4.17.1]
# ‚úó CRITICAL CVE-2024-5678 [pkg:deb/ubuntu/openssl@3.0.2]
# Total: 15 vulnerabilities (5 HIGH, 2 CRITICAL)

# === TODO SERVICE ===
echo "=== Todo Service Security Scan (Docker Scout) ==="
docker scout cves todo-service:1.0

# Oodatud v√§ljund:
# ‚úó HIGH CVE-2024-9999 [pkg:maven/org.springframework.boot/spring-boot@3.1.0]
# Total: 12 vulnerabilities (4 HIGH, 1 CRITICAL)
```

#### Samm 2: Trivy Scan

```bash
# === USER SERVICE ===
echo "=== User Service Security Scan (Trivy) ==="
trivy image --severity HIGH,CRITICAL user-service:1.0

# === TODO SERVICE ===
echo "=== Todo Service Security Scan (Trivy) ==="
trivy image --severity HIGH,CRITICAL todo-service:1.0
```

#### Samm 3: Genereeri JSON Raportid

```bash
# User Service
trivy image --format json --output user-service-scan.json user-service:1.0

# Todo Service
trivy image --format json --output todo-service-scan.json todo-service:1.0

# Kontrolli
cat user-service-scan.json | jq '.Results[0].Vulnerabilities | length'
# Oodatud: 15

cat todo-service-scan.json | jq '.Results[0].Vulnerabilities | length'
# Oodatud: 12
```

#### Samm 4: Uuenda Base Image'd

**User Service (Node.js):**

```dockerfile
# Enne
FROM node:18.17.0-slim

# P√§rast
FROM node:18.19.1-slim  # Uusim patch versioon
```

**Todo Service (Java):**

```dockerfile
# Enne
FROM eclipse-temurin:21.0.0-jre-alpine

# P√§rast
FROM eclipse-temurin:21.0.2-jre-alpine  # Uusim patch versioon
```

#### Samm 5: Rebuild ja Skanni Uuesti

```bash
# Rebuild
docker build -t user-service:1.0-fixed ./apps/backend-nodejs
docker build -t todo-service:1.0-fixed ./apps/backend-java-spring

# Skanni uuesti
docker scout cves user-service:1.0-fixed
docker scout cves todo-service:1.0-fixed

# V√µrdle
docker scout compare user-service:1.0 --to user-service:1.0-fixed
# Oodatud: Improvement: -5 vulnerabilities (-3 HIGH, -2 CRITICAL)
```

---

## Kokkuv√µte

### √ïpitud M√µisted

**Vulnerability Scanning:**
- ‚úÖ CVE (Common Vulnerabilities and Exposures) - standardiseeritud turvaaugud
- ‚úÖ CVSS (Common Vulnerability Scoring System) - raskusaste (0-10)
- ‚úÖ Severity levels - LOW, MEDIUM, HIGH, CRITICAL
- ‚úÖ Base image vs language dependencies - erinevad parandamise viisid

**T√∂√∂riistad:**
- ‚úÖ Docker Scout - sisseehitatud, kiire, soovitused
- ‚úÖ Trivy - p√µhjalikum, rohkem formaate, CI/CD integratsioon
- ‚úÖ Vulnerability scannerite v√µrdlus - millal kasutada kumba

**Security Best Practices:**
- ‚úÖ Non-root users - nodejs:1001, spring:1001
- ‚úÖ Minimal base images - Alpine, Distroless
- ‚úÖ Read-only root filesystem - r√ºndaja ei saa malware installida
- ‚úÖ Health checks - automaatne restart kui rakendus hangub
- ‚úÖ Base image uuendamise strateegia - Renovate, Dependabot

**CI/CD:**
- ‚úÖ Automaatne skannimine GitHub Actions/GitLab CI's
- ‚úÖ Fail build kui HIGH/CRITICAL CVE'd
- ‚úÖ Raportid (JSON, HTML, SARIF)
- ‚úÖ GitHub Security tab integratsioon

### Praktiline Checklist

**Enne Production'i:**
- [ ] Skanni k√µik Docker image'd (Docker Scout + Trivy)
- [ ] Parandanud k√µik CRITICAL CVE'd (24h deadline)
- [ ] Parandanud k√µik HIGH CVE'd (7 p√§eva deadline)
- [ ] Non-root user kasutuses (nodejs:1001, spring:1001)
- [ ] Minimal base image (Alpine v√µi Distroless)
- [ ] Health checks lisatud (HEALTHCHECK Dockerfile'is)
- [ ] CI/CD pipeline skannib automaatselt (GitHub Actions, GitLab CI)
- [ ] Renovate/Dependabot seadistatud (automaatsed base image uuendused)

**Production'is:**
- [ ] Skanni kord n√§dalas (scheduled scan)
- [ ] Monitor GitHub Security tab (uued CVE'd)
- [ ] Uuenda base image'd 30 p√§eva jooksul (MEDIUM CVE'd)
- [ ] Uuenda base image'd 7 p√§eva jooksul (HIGH CVE'd)
- [ ] Uuenda base image'd 24h jooksul (CRITICAL CVE'd)

### Edasi Lugemiseks

- [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
- [NIST National Vulnerability Database](https://nvd.nist.gov/)
- [CVSS Calculator](https://www.first.org/cvss/calculator/3.1)
- [Docker Scout Documentation](https://docs.docker.com/scout/)
- [Trivy Documentation](https://trivy.dev/)
- [OWASP Docker Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html)

---

**Viimane uuendus:** 2025-01-20
